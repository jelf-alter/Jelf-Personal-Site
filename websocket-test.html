<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .connecting { background-color: #fff3cd; color: #856404; }
        .messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; padding: 5px; background: #f8f9fa; border-left: 3px solid #007bff; }
        .controls { margin: 10px 0; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status" class="status connecting">Connecting...</div>
    
    <div class="controls">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="subscribe('pipeline')">Subscribe to Pipeline</button>
        <button onclick="subscribe('testing')">Subscribe to Testing</button>
        <button onclick="sendPing()">Send Ping</button>
        <button onclick="clearMessages()">Clear Messages</button>
    </div>
    
    <div id="messages" class="messages"></div>
    
    <script>
        let ws = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectInterval = 2000;
        
        const status = document.getElementById('status');
        const messages = document.getElementById('messages');
        
        function updateStatus(text, className) {
            status.textContent = text;
            status.className = `status ${className}`;
        }
        
        function addMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${text}`;
            messages.appendChild(message);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                addMessage('Already connected', 'warning');
                return;
            }
            
            updateStatus('Connecting...', 'connecting');
            ws = new WebSocket('ws://localhost:3001/ws');
            
            ws.onopen = function() {
                updateStatus('Connected to WebSocket server', 'connected');
                addMessage('‚úì Connected to WebSocket server', 'success');
                reconnectAttempts = 0;
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addMessage(`üì® Received: ${JSON.stringify(data, null, 2)}`, 'message');
                    
                    // Handle specific message types
                    if (data.type === 'connection_status') {
                        if (data.data.status === 'connected') {
                            addMessage(`üîó Client ID: ${data.data.clientId}`, 'info');
                        }
                    }
                } catch (e) {
                    addMessage(`üì® Received (raw): ${event.data}`, 'message');
                }
            };
            
            ws.onclose = function(event) {
                updateStatus(`WebSocket connection closed (${event.code})`, 'disconnected');
                addMessage(`‚ùå Connection closed: Code ${event.code}, Reason: ${event.reason || 'No reason provided'}`, 'error');
                
                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    addMessage(`üîÑ Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`, 'info');
                    setTimeout(connect, reconnectInterval);
                }
            };
            
            ws.onerror = function(error) {
                updateStatus('WebSocket error occurred', 'disconnected');
                addMessage(`‚ùå WebSocket error: ${error.message || 'Unknown error'}`, 'error');
                console.error('WebSocket error:', error);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close(1000, 'Manual disconnect');
                ws = null;
                updateStatus('Disconnected', 'disconnected');
                addMessage('üîå Manually disconnected', 'info');
            }
        }
        
        function subscribe(channel) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'subscribe',
                    channel: channel
                };
                ws.send(JSON.stringify(message));
                addMessage(`üì° Subscribed to channel: ${channel}`, 'info');
            } else {
                addMessage('‚ùå Not connected. Cannot subscribe.', 'error');
            }
        }
        
        function sendPing() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    type: 'ping'
                };
                ws.send(JSON.stringify(message));
                addMessage('üèì Ping sent', 'info');
            } else {
                addMessage('‚ùå Not connected. Cannot send ping.', 'error');
            }
        }
        
        function clearMessages() {
            messages.innerHTML = '';
        }
        
        // Auto-connect on page load
        connect();
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close(1000, 'Page unload');
            }
        });
    </script>
</body>
</html>